From 6d26cdca0bb8358cd56e78f7c329a2a23ba33948 Mon Sep 17 00:00:00 2001
From: Markus Pfau <pfau@peak3d.de>
Date: Sun, 5 Feb 2017 22:21:35 +0100
Subject: [PATCH] jemalloc depend build

---
 CMakeLists.txt                            |  3 ++-
 cmake/modules/Findjemalloc.cmake          | 44 +++++++++++++++++++++++++++++++
 cmake/scripts/linux/ArchSetup.cmake       |  4 +++
 tools/depends/target/Makefile             |  4 +++
 tools/depends/target/libjemalloc/Makefile | 44 +++++++++++++++++++++++++++++++
 5 files changed, 98 insertions(+), 1 deletion(-)
 create mode 100644 cmake/modules/Findjemalloc.cmake
 create mode 100644 tools/depends/target/libjemalloc/Makefile

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 87550ed..52448e0 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -56,6 +56,7 @@ if(UNIX)
     option(ENABLE_X11         "Enable X11 support?" ON)
     option(ENABLE_AML         "Enable AML?" OFF)
     option(ENABLE_IMX         "Enable IMX?" OFF)
+    option(ENABLE_JEMALLOC    "Enable JEMALLOC?" OFF)
   endif()
 endif()
 # System options
@@ -115,7 +116,7 @@ if(CORE_SYSTEM_NAME STREQUAL android)
 endif()
 
 # Optional dependencies
-set(optional_deps MicroHttpd MySqlClient SSH XSLT
+set(optional_deps MicroHttpd MySqlClient SSH XSLT JEMALLOC
                   Alsa UDEV DBus Avahi MDNS SmbClient CCache
                   PulseAudio VDPAU VAAPI Bluetooth CAP Python)
 
diff --git a/cmake/modules/FindJEMALLOC.cmake b/cmake/modules/FindJEMALLOC.cmake
new file mode 100644
index 0000000..6fa1952
--- /dev/null
+++ b/cmake/modules/FindJEMALLOC.cmake
@@ -0,0 +1,44 @@
+#.rst:
+# FindJEMALLOC
+# -------
+# Finds the JEMALLOC library
+#
+# This will will define the following variables::
+#
+# JEMALLOC_FOUND - system has JEMALLOC
+# JEMALLOC_INCLUDE_DIRS - the JEMALLOC include directory
+# JEMALLOC_LIBRARIES - the JEMALLOC libraries
+#
+# and the following imported targets::
+#
+#   JEMALLOC::JEMALLOC   - The JEMALLOC library
+
+if(PKG_CONFIG_FOUND)
+  pkg_check_modules(PC_JEMALLOC libjemalloc QUIET)
+endif()
+
+find_path(JEMALLOC_INCLUDE_DIR NAMES jemalloc/jemalloc.h
+                          PATHS ${PC_JEMALLOC_INCLUDEDIR})
+find_library(JEMALLOC_LIBRARY NAMES jemalloc libjemalloc jemalloc_pic libjemalloc_pic
+                         PATHS ${PC_JEMALLOC_LIBDIR})
+
+set(JEMALLOC_VERSION ${PC_JEMALLOC_VERSION})
+
+include(FindPackageHandleStandardArgs)
+find_package_handle_standard_args(JEMALLOC
+                                  REQUIRED_VARS JEMALLOC_LIBRARY JEMALLOC_INCLUDE_DIR
+                                  VERSION_VAR JEMALLOC_VERSION)
+
+if(JEMALLOC_FOUND)
+  set(JEMALLOC_LIBRARIES ${JEMALLOC_LIBRARY})
+  set(JEMALLOC_INCLUDE_DIRS ${JEMALLOC_INCLUDE_DIR})
+
+  if(NOT TARGET JEMALLOC::JEMALLOC)
+    add_library(JEMALLOC::JEMALLOC UNKNOWN IMPORTED)
+    set_target_properties(JEMALLOC::JEMALLOC PROPERTIES
+                                   IMPORTED_LOCATION "${JEMALLOC_LIBRARY}"
+                                   INTERFACE_INCLUDE_DIRECTORIES "${JEMALLOC_INCLUDE_DIR}")
+  endif()
+endif()
+
+mark_as_advanced(JEMALLOC_INCLUDE_DIR JEMALLOC_LIBRARY)
diff --git a/cmake/scripts/linux/ArchSetup.cmake b/cmake/scripts/linux/ArchSetup.cmake
index eeed920..24965ee 100644
--- a/cmake/scripts/linux/ArchSetup.cmake
+++ b/cmake/scripts/linux/ArchSetup.cmake
@@ -44,3 +44,7 @@ endif()
 if(ENABLE_MIR)
   set(ENABLE_VDPAU OFF CACHE BOOL "Disabling VDPAU since no Mir support" FORCE)
 endif()
+
+if(CPU MATCHES 64)
+  set(ENABLE_JEMALLOC ON CACHE BOOL "Enable jmalloc allocator for 64-bit linux builds" FORCE)
+endif()
diff --git a/tools/depends/target/Makefile b/tools/depends/target/Makefile
index 9d0c722..10ccbc8 100644
--- a/tools/depends/target/Makefile
+++ b/tools/depends/target/Makefile
@@ -26,6 +26,10 @@ else
   DEPENDS+=samba libcdio
 endif
 
+ifeq ($(OS),linux)
+  DEPENDS += libjemalloc
+endif
+
 ifeq ($(OS),ios)
   EXCLUDED_DEPENDS = libcec libusb libdvdcss
   ifeq ($(TARGET_PLATFORM),appletvos)
diff --git a/tools/depends/target/libjemalloc/Makefile b/tools/depends/target/libjemalloc/Makefile
new file mode 100644
index 0000000..253553e
--- /dev/null
+++ b/tools/depends/target/libjemalloc/Makefile
@@ -0,0 +1,44 @@
+include ../../Makefile.include
+DEPS= ../../Makefile.include Makefile
+
+# lib name, version
+LIBNAME=libjemalloc
+VERSION=3
+SOURCE=$(LIBNAME)-$(VERSION)
+ARCHIVE=$(SOURCE).tar.gz
+
+# configuration settings
+CONFIGURE=cp -f $(CONFIG_SUB) $(CONFIG_GUESS) .; \
+          ./configure --prefix=$(PREFIX)
+
+LIBDYLIB=$(PLATFORM)/$(LIBNAME)/.libs/$(LIBNAME).a
+
+CLEAN_FILES=$(ARCHIVE) $(PLATFORM)
+
+all: .installed-$(PLATFORM)
+
+$(TARBALLS_LOCATION)/$(ARCHIVE):
+	cd $(TARBALLS_LOCATION); $(RETRIEVE_TOOL) $(RETRIEVE_TOOL_FLAGS) $(BASE_URL)/$(ARCHIVE)
+
+$(PLATFORM): $(TARBALLS_LOCATION)/$(ARCHIVE) $(DEPS)
+	rm -rf $(PLATFORM)/*; mkdir -p $(PLATFORM)
+	cd $(PLATFORM); $(ARCHIVE_TOOL) $(ARCHIVE_TOOL_FLAGS) $(TARBALLS_LOCATION)/$(ARCHIVE)
+	$(info $(AUTORECONF))
+	cd $(PLATFORM); $(AUTOCONF)
+	cd $(PLATFORM); $(CONFIGURE)
+
+$(LIBDYLIB): $(PLATFORM)
+	$(MAKE) -C $(PLATFORM) build_lib_static
+
+.installed-$(PLATFORM): $(LIBDYLIB)
+	$(MAKE) -C $(PLATFORM) install_include
+	$(MAKE) -C $(PLATFORM) install_lib_static
+	touch $@
+
+clean:
+	$(MAKE) -C $(PLATFORM) clean
+	rm -f .installed-$(PLATFORM)
+
+distclean::
+	rm -rf $(PLATFORM) .installed-$(PLATFORM)
+
